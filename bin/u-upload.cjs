#!/usr/bin/env node
"use strict";const a=require("commander"),p=require("net"),d=require("@xiaou66/interconnect-client"),i=require("node:os"),m=require("node:child_process"),f="1.0.5",g="用于命令行上传图片到uTools图床Plus插件的工具",l={version:f,description:g},{ServiceClient:y}=d;async function h(s,o){const{uploadId:n,timeout:t=15e3}=o;console.log(i.type()==="Windows_NT",i.type());try{const r=await new y(p,"picture-bed-plus","command",i.type()==="Windows_NT").callServiceMethod("service.upload.file.sync",{filePath:s,uploadWay:n},{timeout:t});return{url:(r==null?void 0:r.url)||"",success:!!(r!=null&&r.url)}}catch(e){return e.message.includes("ECONNREFUSED")?{url:"",success:!1,error:"uTools 图床Plus 服务未启动，请先在 uTools 中打开 图床Plus 插件"}:{url:"",success:!1,error:e.message||"未知错误"}}}async function w(s,o){const n=[];for(const t of s){const e=await h(t,o);n.push(e)}return n}a.program.version(l.version).description(l.description);function v(s){let o;switch(process.platform){case"darwin":o=`open "${s}"`;break;case"win32":o=`start "${s}"`;break;case"linux":o=`xdg-open "${s}"`;break;default:console.error("Unsupported platform");return}m.execSync(o)}a.program.arguments("<imagePaths...>").description("图片地址，可传多个").option("-u, --uploadId <uploadId>","图床源,需要和「utools」图床Plus 填写存储源id").option("-t, --timeout <timeout>","上传超时时间（毫秒），默认15000","15000").action(async(s,{uploadId:o,timeout:n},t)=>{try{const e=await w(s,{uploadId:o,timeout:parseInt(n,10)});let r=0;e.forEach((c,P)=>{var u;c.success?(console.log(c.url),r++):((u=c.error)!=null&&u.includes("服务未启动")&&v("utools://图床 Plus/图床"),console.log(c.error))}),process.exit(r>0?0:1)}catch(e){console.error("上传过程出现错误:",e instanceof Error?e.message:String(e)),process.exit(1)}});a.program.parse();
